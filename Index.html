<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blood - Mobile Web App</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071022;
    --card:#0b1220;
    --accent:#e11d48;
    --muted:#94a3b8;
    --white: #e6eef7;
    --success:#16a34a;
    --danger:#ef4444;
    --glass-border: rgba(255,255,255,0.06);
    --neon: 0 0 16px rgba(225,29,72,0.18), 0 0 32px rgba(225,29,72,0.08);
    --header-h:64px;
    --footer-h:86px;
    --active-color: #e11d48;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg,#061426 0%, #071022 100%);color:var(--white);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow:hidden}
  #loadingScreen {
    position: fixed;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #000;
    z-index: 9999;
  }
  #squidIntro {
    display: flex;
    gap: 8px;
  }
  #squidIntro .letter {
    font-size: 64px;
    font-weight: 900;
    opacity: 0;
    transform: scale(0.5) translateY(60px);
    color: #e11d48;
    text-shadow: 0 0 12px rgba(225,29,72,0.4);
    animation: riseUp 0.6s ease forwards;
  }
  #squidIntro .letter:nth-child(1){ animation-delay: 0s; }
  #squidIntro .letter:nth-child(2){ animation-delay: 0.2s; }
  #squidIntro .letter:nth-child(3){ animation-delay: 0.4s; }
  #squidIntro .letter:nth-child(4){ animation-delay: 0.6s; }
  #squidIntro .letter:nth-child(5){ animation-delay: 0.8s; }
  @keyframes riseUp {
    0%   { opacity: 0; transform: scale(0.5) translateY(60px) rotate(-8deg); }
    60%  { opacity: 1; transform: scale(1.2) translateY(0) rotate(3deg); }
    100% { opacity: 1; transform: scale(1) translateY(0) rotate(0); }
  }
  #loadingFrom {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 14px;
    color: #aaa;
    opacity: 0;
    animation: fadeIn 1s ease forwards;
    animation-delay: 1.2s;
  }
  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }
  #app{display:none;height:100%;width:100%;position:relative;overflow:hidden}
  header.app-header{position:fixed;top:0;left:0;right:0;height:var(--header-h);display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-bottom:1px solid var(--glass-border);z-index:30}
  .brand{display:flex;align-items:center;gap:12px;cursor:pointer;}
  .drop{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:24px}
  .brand h1{font-size:18px;margin:0}
  .menu-btn{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid var(--glass-border);background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent)}
  #menuOverlay{position:fixed;inset:0;background:rgba(2,6,23,0.8);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:60;padding:20px}
  #menuOverlay.visible{display:flex}
  #menuOverlay .closeX{position:absolute;top:18px;right:18px;font-size:28px;cursor:pointer}
  #menuOverlay .menuItem{width:100%;max-width:420px;background:linear-gradient(180deg,#071022, #08122a);border-radius:12px;padding:16px;margin:8px 0;border:1px solid var(--glass-border);display:flex;align-items:center;justify-content:space-between;cursor:pointer}
  #menuOverlay .menuItem h3{margin:0;font-size:18px}
  #menuOverlay .menuItem p{margin:0;color:var(--muted);font-size:13px}
  main{position:absolute;inset:var(--header-h) 0 var(--footer-h) 0; -webkit-overflow-scrolling: touch}
  .page {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    opacity: 0;
    transition: opacity 0.4s ease-in-out;
    padding: 12px 14px;
    overflow: auto;
    height: 100%;
  }
  .page.active {
    display: block;
    opacity: 1;
  }
  .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid var(--glass-border);display:flex;gap:12px;align-items:center;cursor:pointer;}
  .card.clickable:hover{opacity:0.8;}
  .avatar{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,#0b1220,#09101a);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px;color:var(--white);border:1px solid rgba(255,255,255,0.04)}
  .card-body{flex:1}
  .name-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .meta{font-size:13px;color:var(--muted);margin-top:6px}
  .tag{padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .eligible{background:rgba(22,163,74,0.14);color:var(--success);border:1px solid rgba(22,163,74,0.08)}
  .not-eligible{background:rgba(239,68,68,0.06);color:var(--danger);border:1px solid rgba(239,68,68,0.06)}
  .blood-group{font-size:18px;font-weight:800;letter-spacing:0.6px}
  .ratings { color: #f5b041; }
  .rating-star { font-size: 16px; margin: 0 1px; }
  .add-center{display:flex;align-items:center;justify-content:center;height:60vh;flex-direction:column}
  
  /* Plus icon professional design */
  .big-plus{
    width: 120px;
    height: 120px;
    border-radius: 25px; /* More rounded corners for a modern look */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 60px; /* Larger plus sign */
    color: var(--white);
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
    border: 1px solid rgba(255, 255, 255, 0.1);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: 0 8px 30px rgba(225, 29, 72, 0.2), inset 0 0 10px rgba(255, 255, 255, 0.1);
}

.big-plus::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0) 100%);
    transform: translateX(-100%) skewX(-30deg);
    transition: transform 0.6s ease;
}

.big-plus:hover {
    transform: scale(1.05) translateY(-5px);
    border-color: rgba(225, 29, 72, 0.6);
    box-shadow: 0 12px 40px rgba(225, 29, 72, 0.4), inset 0 0 15px rgba(255, 255, 255, 0.2);
}

.big-plus:hover::before {
    transform: translateX(100%) skewX(-30deg);
}

  /* Spinning animation */
  @keyframes spin {
    0% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.1); }
    100% { transform: rotate(360deg) scale(1); }
  }

  .spin-animation {
    animation: spin 0.6s ease-in-out;
  }
  
  footer.app-footer {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 10px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding: 8px 10px;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    width: 90%;
    max-width: 450px;
    z-index: 40;
    border: 0.1px solid var(--glass-border);
    backdrop-filter: blur(6px);
    /* Updated gap value */
    gap: 8px; 
  }
  .nav-btn {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    cursor: pointer;
    font-size: 12px;
    color: var(--muted);
    gap: 6px;
    transition: all 0.3s ease;
  }
  .nav-btn.active {
    color: var(--active-color);
    font-weight: 600;
    background-color: rgba(255, 255, 255, 0.05);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), 0 0 10px rgba(225, 29, 72, 0.2);
  }
  .nav-btn.active svg {
    color: var(--active-color);
  }
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:70;padding:18px}
  .modal-backdrop.visible{display:flex}
  .modal{width:100%;max-width:640px;background:linear-gradient(180deg,#071022,#04101a);border-radius:12px;padding:18px;border:1px solid var(--glass-border)}
  .review-card {
    background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 8px;
  }
  .review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .review-meta {
    font-size: 12px;
    color: var(--muted);
  }
  .auth-compact{max-width:420px;margin:20px auto;background:linear-gradient(180deg,#07101a,#04101a);padding:14px;border-radius:12px;border:1px solid var(--glass-border)}
  .auth-compact input, .auth-compact select, .auth-compact textarea{width:100%;padding:10px;margin-top:8px;border-radius:10px;border:1px solid var(--glass-border);background:transparent;color:var(--white)}
  .auth-compact .row{display:flex;gap:8px}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(90deg,#ff6b86,#e11d48);color:white}
  .btn.ghost{background:transparent;border:1px solid var(--glass-border);color:var(--white)}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:12px}
  a.link{color:#ffd2db;text-decoration:none}
  @media(min-width:720px){
    main{inset:84px 80px 110px 80px}
    .grid{grid-template-columns:repeat(2,1fr)}
  }
  .search-input-group {
    display: flex;
    align-items: center;
    border-radius: 12px;
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--glass-border);
    padding: 6px;
  }
  #searchInput {
    flex: 1;
    background: transparent;
    color: var(--white);
    border: none;
    padding: 6px 10px;
    font-size: 16px;
    outline: none;
  }
  #searchInput::placeholder {
    color: var(--muted);
  }
  #clearSearch {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 18px;
    cursor: pointer;
    padding: 0 8px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  #clearSearch.visible {
    opacity: 1;
    pointer-events: auto;
  }
  #logoutReasonModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(2,6,23,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 70;
    padding: 18px;
  }
  .auth-form-container {
      padding: 24px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 420px;
      width: 100%;
      margin: 20px auto;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      animation: fadeInScale 0.4s ease-out;
  }
  @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
  }
  .auth-form-container h3 {
      text-align: center;
      margin-top: 0;
      color: var(--white);
      font-size: 24px;
      font-weight: 700;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
  }
  .auth-form-container p {
      font-size: 14px;
      text-align: center;
      color: var(--muted);
      margin-bottom: 24px;
  }
  .auth-form-container .input-group {
      margin-bottom: 16px;
  }
  .auth-form-container label {
      display: block;
      margin-bottom: 6px;
      color: var(--muted);
      font-size: 14px;
  }
  .auth-form-container input, .auth-form-container select, .auth-form-container textarea {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      color: var(--white);
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s, background 0.3s;
  }
  .auth-form-container input:focus, .auth-form-container select:focus, .auth-form-container textarea:focus {
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.1);
  }
  .auth-form-container .btn-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
  }
  .auth-form-container .btn {
      flex: 1;
      margin: 0 4px;
      border-radius: 10px;
      padding: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
  }
  .auth-form-container .btn.primary {
      background: linear-gradient(90deg, #ff6b86, #e11d48);
      color: white;
      box-shadow: 0 4px 15px rgba(225, 29, 72, 0.4);
  }
  .auth-form-container .btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(225, 29, 72, 0.6);
  }
  .auth-form-container .btn.ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--white);
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.05);
  }
  .auth-form-container .btn.ghost:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 6px 20px rgba(255, 255, 255, 0.1);
  }
  .auth-form-container .text-link {
      text-align: center;
      margin-top: 16px;
  }
  .btn.emergency {
    width: 100%;
    background: linear-gradient(90deg, #ff4c4c, #e52e2e);
    color: white;
    padding: 14px;
    border-radius: 12px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(229, 46, 46, 0.4);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .btn.emergency:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(229, 46, 46, 0.6);
  }
  .emergency-card {
    background: linear-gradient(180deg, #ff4c4c, #e52e2e);
    color: white;
    padding: 16px;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 12px;
    box-shadow: 0 8px 32px 0 rgba(229, 46, 46, 0.4);
    animation: pulse 1.5s infinite;
  }
  .emergency-card .blood-group-large {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: 1px;
      color: #fff;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      background: rgba(0, 0, 0, 0.15);
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.4);
  }
  @keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 10px rgba(229, 46, 46, 0.4), 0 0 0 0 rgba(229, 46, 46, 0.7);
    }
    50% {
        transform: scale(1.02);
        box-shadow: 0 0 20px rgba(229, 46, 46, 0.6), 0 0 0 10px rgba(229, 46, 46, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 10px rgba(229, 46, 46, 0.4), 0 0 0 0 rgba(229, 46, 46, 0);
    }
  }
  .emergency-profile-card {
    background: rgba(229, 46, 46, 0.1);
    border: 1px solid rgba(229, 46, 46, 0.3);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
  }
  .btn.small {
    padding: 8px 12px;
    font-size: 14px;
  }
  /* New emergency icon pulse effect */
  @keyframes emergency-pulse {
      0%, 100% {
          color: #ef4444; /* Red */
      }
      50% {
          color: #f59e0b; /* Yellow */
      }
  }
  .nav-btn.has-emergency svg {
      animation: emergency-pulse 1s infinite;
  }
  /* Custom Calendar Styles */
  .custom-calendar-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(6px);
      z-index: 80;
  }
  .custom-calendar-modal.visible {
      display: flex;
  }
  .calendar-container {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      width: 90%;
      max-width: 320px;
      border: 1px solid var(--glass-border);
  }
  .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
  }
  .calendar-header h4 {
      margin: 0;
  }
  .calendar-header button {
      background: transparent;
      border: none;
      color: var(--white);
      font-size: 24px;
      cursor: pointer;
  }
  .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      text-align: center;
  }
  .calendar-day, .calendar-date {
      padding: 8px;
      border-radius: 8px;
  }
  .calendar-day {
      font-weight: 600;
      color: var(--muted);
      font-size: 12px;
  }
  .calendar-date {
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
  }
  .calendar-date:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.05);
  }
  .calendar-date.current {
      background: var(--accent);
      color: white;
  }
  .calendar-date.selected {
      background: var(--success);
      color: white;
  }
  .calendar-date.disabled {
      color: var(--muted);
      cursor: not-allowed;
      opacity: 0.5;
  }
</style>
</head>
<body>
<div id="logoutReasonModal" class="modal-backdrop" style="display:none;">
    <div class="modal">
        <h3>Logout</h3>
        <p class="muted">কেনো লগআউট করতে চাচ্ছেন?</p>
        <div style="margin-top:8px">
            <textarea id="logoutReasonInput" rows="3" style="width:100%;border-radius:8px;padding:8px;border:1px solid var(--glass-border);background:transparent;color:var(--white)"></textarea>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
                <button class="btn ghost" onclick="document.getElementById('logoutReasonModal').style.display='none'">Cancel</button>
                <button class="btn primary" id="logoutReasonSubmit">Submit & Logout</button>
            </div>
        </div>
    </div>
</div>
<div id="loadingScreen">
  <div id="squidIntro">
    <span class="letter">B</span>
    <span class="letter">L</span>
    <span class="letter">O</span>
    <span class="letter">O</span>
    <span class="letter">D</span>
  </div>
  <div id="loadingFrom">from Appozi</div>
</div>
<div id="app" aria-hidden="true">
  <header class="app-header" role="banner">
    <div class="brand" aria-hidden="false" onclick="scrollToTop()">
      <div class="drop">🩸</div>
      <div>
        <h1>Blood</h1>
        <div class="muted small">রক্তের সহায়তা</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <div id="userBadge" class="muted small" style="display:none"></div>
      <div id="menuBtn" class="menu-btn" aria-label="Open menu" title="Menu">
        <svg width="20" height="14" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path></svg>
      </div>
    </div>
  </header>
  <div id="menuOverlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="closeX" id="closeMenu" aria-label="Close menu">×</div>
    <div class="menuItem" id="aboutBtn" role="button" tabindex="0">
      <div>
        <h3>About</h3>
        <p class="muted">অ্যাপের কাজ ও উদ্দেশ্য</p>
      </div>
      <div>›</div>
    </div>
    <div class="menuItem" id="guidelinesBtn" role="button" tabindex="0">
      <div>
        <h3>Guidelines</h3>
        <p class="muted">ডোনারের সাথে আচরণ</p>
      </div>
      <div>›</div>
    </div>
    <div class="menuItem" id="logoutBtn" role="button" tabindex="0">
      <div>
        <h3>Logout</h3>
        <p class="muted">অ্যাকাউন্ট থেকে বের হয়ে যান</p>
      </div>
      <div>›</div>
    </div>
  </div>
  <main role="main">
    <section id="homePage" class="page active" aria-label="Home">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <h2 style="margin:0">Home</h2>
        <div class="muted small">সকল ডোনার</div>
      </div>
      <div id="donorsGrid" class="grid" aria-live="polite"></div>
      <div id="noData" class="muted" style="display:none;margin-top:20px">ডোনার লোড হচ্ছে...</div>
    </section>
    <section id="searchPage" class="page" aria-label="Search">
      <div class="search-input-group" style="margin-bottom:12px">
        <input id="searchInput" placeholder="খুঁজুন....." />
        <button id="clearSearch" aria-label="Clear search">×</button>
      </div>
      <div id="searchGrid" class="grid"></div>
      <div id="noSearch" class="muted" style="display:none;margin-top:20px">কোনো ফলাফল মেলেনি।</div>
    </section>
    <section id="addPage" class="page" aria-label="Add">
      <div class="add-center">
        <div class="muted">নতুন ডোনার যোগ করতে নিচের প্লাস আইকনে চাপ দিন</div>
        <div id="addPlus" class="big-plus" aria-label="Add donor">＋</div>
        <div class="muted small">নিজে রক্ত দান করুন এবং অন্যদের রক্ত দানে উৎসাহিত করুন</div>
      </div>
    </section>
    <section id="profilePage" class="page" aria-label="Profile">
      <h2>Profile</h2>
      <div style="margin-top:12px" id="profileInfo"></div>
      <h3 style="margin-top:18px">Your Added Donors</h3>
      <div id="myDonors" class="grid" style="margin-top:12px"></div>
      <div id="noMyDonors" class="muted" style="display:none;margin-top:12px">তুমি এখনও কোনো ডোনার যোগ করোনি।</div>
    </section>
    <section id="emergencyPage" class="page" aria-label="Emergency Posts">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <h2 style="margin:0">Emergency Posts</h2>
      </div>
      <div id="emergencyGrid" class="grid" aria-live="polite"></div>
      <div id="noEmergencyPosts" class="muted" style="display:none;margin-top:20px">কোনো ইমার্জেন্সি পোস্ট নেই।</div>
    </section>
  </main>
  <footer class="app-footer" role="navigation" aria-label="Footer">
      <div id="navEmergency" class="nav-btn" title="Emergency">
          <svg id="emergencyIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" class="feather feather-alert-triangle"><path d="M10.29 3.86L1.86 19.34C1.3 20.29 2 21.5 3.09 21.5h17.82c1.09 0 1.79-1.21 1.23-2.16L13.71 3.86c-.45-.78-1.57-.78-2.02 0zM12 9v4M12 17h.01"></path></svg>
          <div class="small">Urgent</div>
      </div>
    <div id="navSearch" class="nav-btn" title="Search">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"></path></svg>
      <div class="small">Search</div>
    </div>
      <div id="navHome" class="nav-btn active" title="Home">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 10.5L12 4l9 6.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V10.5z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"></path></svg>
      <div class="small">Home</div>
    </div>
    <div id="navAdd" class="nav-btn" title="Add">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path></svg>
      <div class="small">Add</div>
    </div>
    <div id="navProfile" class="nav-btn" title="Profile">
      <div id="profileIconContainer">
        <svg width="20" height="20" viewBox="0 0 0 24 24" fill="none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"></path></svg>
      </div>
      <div class="small">Profile</div>
    </div>
  </footer>
</div>
<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div id="modalContent"></div>
  </div>
</div>

<div id="customCalendarModal" class="custom-calendar-modal" aria-hidden="true">
    <div class="calendar-container">
        <div class="calendar-header">
            <button id="prevMonthBtn">‹</button>
            <h4 id="calendarMonthYear">Blood Calendar - </h4>
            <button id="nextMonthBtn">›</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px">
            <button class="btn ghost small" id="clearDateBtn">Clear Date</button>
            <button class="btn ghost small" onclick="closeCalendarModal()">Cancel</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDtFcTxfwB2tkfVx0MpnFZKpd7ibSqYudU",
  authDomain: "blood-bfa8c.firebaseapp.com",
  projectId: "blood-bfa8c",
  storageBucket: "blood-bfa8c.appspot.com",
  messagingSenderId: "460305345299",
  appId: "1:460305345299:web:1f07370c34a61755a748e6",
  measurementId: "G-ZJMLVH8XN0",
  databaseURL: "https://blood-bfa8c-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const loadingScreen = document.getElementById('loadingScreen');
const app = document.getElementById('app');
const menuBtn = document.getElementById('menuBtn');
const menuOverlay = document.getElementById('menuOverlay');
const closeMenu = document.getElementById('closeMenu');
const aboutBtn = document.getElementById('aboutBtn');
const guidelinesBtn = document.getElementById('guidelinesBtn');
const logoutBtn = document.getElementById('logoutBtn');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalContent = document.getElementById('modalContent');
const pages = {
  home: document.getElementById('homePage'),
  search: document.getElementById('searchPage'),
  add: document.getElementById('addPage'),
  profile: document.getElementById('profilePage'),
  emergency: document.getElementById('emergencyPage')
};
const donorsGrid = document.getElementById('donorsGrid');
const searchGrid = document.getElementById('searchGrid');
const myDonorsGrid = document.getElementById('myDonors');
const emergencyGrid = document.getElementById('emergencyGrid');
const noData = document.getElementById('noData');
const noMyDonors = document.getElementById('noMyDonors');
const noSearch = document.getElementById('noSearch');
const noEmergencyPosts = document.getElementById('noEmergencyPosts');
const navHome = document.getElementById('navHome');
const navSearch = document.getElementById('navSearch');
const navAdd = document.getElementById('navAdd');
const navProfile = document.getElementById('navProfile');
const navEmergency = document.getElementById('navEmergency');
const emergencyIcon = document.getElementById('emergencyIcon');
const profileIconContainer = document.getElementById('profileIconContainer');
const searchInput = document.getElementById('searchInput');
const clearSearch = document.getElementById('clearSearch');
const addPlus = document.getElementById('addPlus');
const addPage = document.getElementById('addPage');
const userBadge = document.getElementById('userBadge');
const logoutReasonModal = document.getElementById('logoutReasonModal');
const logoutReasonInput = document.getElementById('logoutReasonInput');
const logoutReasonSubmit = document.getElementById('logoutReasonSubmit');
let donors = {};
let users = {};
let allEmergencyPosts = {};
let currentUser = null;
let donorsRef = firebase.database().ref('donors');
let usersRef = firebase.database().ref('users');
let emergencyRef = firebase.database().ref('emergencyPosts');
let appRatingsRef = firebase.database().ref('appRatings');
const customCalendarModal = document.getElementById('customCalendarModal');
const calendarMonthYear = document.getElementById('calendarMonthYear');
const calendarGrid = document.getElementById('calendarGrid');
const prevMonthBtn = document.getElementById('prevMonthBtn');
const nextMonthBtn = document.getElementById('nextMonthBtn');
const clearDateBtn = document.getElementById('clearDateBtn');
let activeDateInput = null;
let currentCalendarDate = new Date();

function fmtDate(d){ const dt = new Date(d); if(isNaN(dt)) return "-"; return dt.toLocaleDateString(); }
function daysBetween(a,b){ return Math.ceil((b - a)/(1000*60*60*24)); }
function uidInitials(name){ if(!name) return "?"; return name.trim().split(" ").map(s=>s[0]?.toUpperCase()).slice(0,2).join(""); }
function escapeHtml(unsafe) {
  if (unsafe === undefined || unsafe === null) return '';
  return String(unsafe)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
function formatInputDate(iso){ if(!iso) return ''; const d=new Date(iso); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function renderStars(rating){
  let stars = '';
  for(let i=1; i<=5; i++){
    stars += `<span class="rating-star" style="color: ${i <= rating ? '#f5b041' : 'var(--muted)'}">★</span>`;
  }
  return stars;
}
function openModal(html){ modalContent.innerHTML = html; modalBackdrop.classList.add('visible'); modalBackdrop.setAttribute('aria-hidden','false'); }
function closeModal(){ modalBackdrop.classList.remove('visible'); modalBackdrop.setAttribute('aria-hidden','true'); }
modalBackdrop.addEventListener('click', (e)=> { if(e.target === modalBackdrop) closeModal(); });
menuBtn.addEventListener('click', ()=> {
  menuOverlay.classList.add('visible');
  menuOverlay.setAttribute('aria-hidden','false');
});
closeMenu.addEventListener('click', ()=> {
  menuOverlay.classList.remove('visible');
  menuOverlay.setAttribute('aria-hidden','true');
});
function closeMenuFunc(){ menuOverlay.classList.remove('visible'); menuOverlay.setAttribute('aria-hidden','true'); }
function setActivePage(name){
  const currentActivePage = document.querySelector('.page.active');
  const nextActivePage = pages[name];
  if (currentActivePage === nextActivePage) {
      return;
  }
  if (currentActivePage) {
      currentActivePage.classList.remove('active');
      setTimeout(() => {
          currentActivePage.style.display = 'none';
      }, 400);
  }
  nextActivePage.style.display = 'block';
  setTimeout(() => {
      nextActivePage.classList.add('active');
  }, 10);
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  if(name === 'home') navHome.classList.add('active');
  if(name === 'search') navSearch.classList.add('active');
  if(name === 'add') navAdd.classList.add('active');
  if(name === 'profile') navProfile.classList.add('active');
  if(name === 'emergency') navEmergency.classList.add('active');
}
navHome.addEventListener('click', () => setActivePage('home'));
navSearch.addEventListener('click', () => {
    if (currentUser) {
        setActivePage('search');
    } else {
        openAuthModal('login');
    }
});
navAdd.addEventListener('click', () => {
    if (currentUser) {
        setActivePage('add');
    } else {
        openAuthModal('login');
    }
});
navEmergency.addEventListener('click', () => {
    setActivePage('emergency');
});
navProfile.addEventListener('click', () => {
    if (currentUser) {
        setActivePage('profile');
    } else {
        openAuthModal('login');
    }
});
setTimeout(()=> {
  loadingScreen.style.opacity = 0;
  setTimeout(()=> { loadingScreen.style.display='none'; app.style.display='block'; app.setAttribute('aria-hidden','false'); }, 220);
}, 2300);

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    currentUser = { uid: user.uid, email: user.email, displayName: user.displayName || user.email };
    userBadge.style.display = 'inline-block';
    userBadge.textContent = currentUser.displayName || currentUser.email;
    logoutBtn.style.display = 'flex';
    profileIconContainer.innerHTML = `<div style="width:20px;height:20px;border-radius:50%;background:var(--accent);color:var(--white);font-size:11px;display:flex;align-items:center;justify-content:center;font-weight:700;">${uidInitials(currentUser.displayName)}</div>`;

    const userRef = firebase.database().ref(`users/${currentUser.uid}`);
    userRef.once('value').then(snapshot => {
      const userData = snapshot.val();
      const loginCount = userData?.loginCount || 0;
      const appRated = userData?.appRated || false;
      const showRatingAfter = userData?.showRatingAfter || 0;
      const now = Date.now();

      if (!appRated && (loginCount >= 3 || now > showRatingAfter)) {
        openAppRatingModal();
        userRef.update({ 
          loginCount: loginCount + 1,
          showRatingAfter: now + 7 * 24 * 60 * 60 * 1000 // ৭ দিন পর
        });
      } else if (!appRated && loginCount < 3) {
        userRef.update({ loginCount: loginCount + 1 });
      }
    });

  } else {
    currentUser = null;
    userBadge.style.display = 'none';
    logoutBtn.style.display = 'none';
    profileIconContainer.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"></path></svg>`;
  }
  renderAll();
});
donorsRef.on('value', snapshot => {
  donors = snapshot.val() || {};
  renderAll();
});
usersRef.on('value', snapshot => {
  users = snapshot.val() || {};
  renderAll();
});
async function addEmergencyPost(post) {
  if (!currentUser) return alert('এই ফিচারটি ব্যবহার করার জন্য লগইন করুন।');
  const postId = 'em_' + Date.now();
  const newPostData = {
    ...post,
    user: currentUser.uid,
    timestamp: firebase.database.ServerValue.TIMESTAMP,
    expiresAt: Date.now() + 24 * 60 * 60 * 1000
  };
  await emergencyRef.child(postId).set(newPostData);
}
async function updateEmergencyPost(postId, post) {
    if (!currentUser) return alert('এই ফিচারটি ব্যবহার করার জন্য লগইন করুন।');
    const existingPost = allEmergencyPosts[postId];
    if (!existingPost || existingPost.user !== currentUser.uid) {
        alert('এই পোস্টটি আপডেট করার অনুমতি নেই।');
        return;
    }
    await emergencyRef.child(postId).update({
        ...post,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
    });
}
async function deleteEmergencyPost(postId) {
  if (!currentUser) return alert('লগইন করুন।');
  const post = allEmergencyPosts[postId];
  if (!post || post.user !== currentUser.uid) {
    alert('এই পোস্টটি মুছে ফেলার অনুমতি নেই।');
    return;
  }
  if (!confirm('আপনি কি এই ইমার্জেন্সি পোস্টটি মুছে ফেলতে চান?')) return;
  await emergencyRef.child(postId).remove();
  alert('ইমার্জেন্সি পোস্ট সফলভাবে মুছে ফেলা হয়েছে।');
}
emergencyRef.on('value', snapshot => {
  const postsData = snapshot.val() || {};
  allEmergencyPosts = {};
  let hasActivePosts = false;
  
  for(const id in postsData) {
      if(postsData[id].expiresAt > Date.now()) {
          allEmergencyPosts[id] = postsData[id];
          hasActivePosts = true;
      } else {
          emergencyRef.child(id).remove();
      }
  }
  if (hasActivePosts) {
      navEmergency.classList.add('has-emergency');
      emergencyIcon.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" class="feather feather-alert-triangle"><path d="M10.29 3.86L1.86 19.34C1.3 20.29 2 21.5 3.09 21.5h17.82c1.09 0 1.79-1.21 1.23-2.16L13.71 3.86c-.45-.78-1.57-.78-2.02 0zM12 9v4M12 17h.01"></path></svg>`;
  } else {
      navEmergency.classList.remove('has-emergency');
      emergencyIcon.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" class="feather feather-alert-triangle"><path d="M10.29 3.86L1.86 19.34C1.3 20.29 2 21.5 3.09 21.5h17.82c1.09 0 1.79-1.21 1.23-2.16L13.71 3.86c-.45-.78-1.57-.78-2.02 0zM12 9v4M12 17h.01"></path></svg>`;
  }
  renderAll();
});

function openEmergencyPostModal(postId = null) {
  if (!currentUser) {
    openAuthModal('login');
    return;
  }
  const isEdit = postId !== null;
  const payload = isEdit && allEmergencyPosts[postId] ? allEmergencyPosts[postId] : {};
  openModal(`
    <div class="auth-form-container">
      <h3>🚨 ইমার্জেন্সি পোস্ট</h3>
      <p class="muted" style="text-align: center;">রক্তের জরুরি প্রয়োজনের জন্য পোস্ট করুন। পোস্টটি ২৪ ঘণ্টা থাকবে।</p>
      
      <div class="input-group">
        <label>রক্তের গ্রুপ</label>
        <select id="emBlood">
          <option value="A+" ${payload.blood === 'A+' ? 'selected' : ''}>A+</option>
          <option value="A-" ${payload.blood === 'A-' ? 'selected' : ''}>A-</option>
          <option value="B+" ${payload.blood === 'B+' ? 'selected' : ''}>B+</option>
          <option value="B-" ${payload.blood === 'B-' ? 'selected' : ''}>B-</option>
          <option value="O+" ${payload.blood === 'O+' ? 'selected' : ''}>O+</option>
          <option value="O-" ${payload.blood === 'O-' ? 'selected' : ''}>O-</option>
          <option value="AB+" ${payload.blood === 'AB+' ? 'selected' : ''}>AB+</option>
          <option value="AB-" ${payload.blood === 'AB-' ? 'selected' : ''}>AB-</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>রোগীর নাম</label>
        <input id="emPatientName" type="text" value="${escapeHtml(payload.patientName || '')}" placeholder="রোগীর নাম"/>
      </div>
      <div class="input-group">
        <label>রোগীর অবস্থা ও প্রয়োজন</label>
        <textarea id="emDetails" rows="3" placeholder="কোথায়, কখন, কতটুকু রক্ত প্রয়োজন, রোগীর অবস্থা ইত্যাদি">${escapeHtml(payload.details || '')}</textarea>
      </div>
      <div class="input-group">
        <label>যোগাযোগের নম্বর</label>
        <input id="emPhone" type="tel" value="${escapeHtml(payload.phone || '')}" placeholder="ফোন নম্বর"/>
      </div>
      <div class="btn-group" style="justify-content:flex-end;">
        <button class="btn ghost" onclick="closeModal()">বাতিল</button>
        <button class="btn primary" id="postEmergencyBtn">${isEdit ? 'আপডেট করুন' : 'পোস্ট করুন'}</button>
      </div>
    </div>
  `);
  setTimeout(() => {
    document.getElementById('postEmergencyBtn').onclick = async () => {
      const newPayload = {
        blood: document.getElementById('emBlood').value,
        patientName: document.getElementById('emPatientName').value.trim(),
        details: document.getElementById('emDetails').value.trim(),
        phone: document.getElementById('emPhone').value.trim(),
      };
      if (!newPayload.blood || !newPayload.details || !newPayload.phone) {
        alert('সকল ফিল্ড পূরণ করা আবশ্যক।');
        return;
      }
      try {
        if(isEdit) {
            await updateEmergencyPost(postId, newPayload);
            alert('ইমার্জেন্সি পোস্ট সফলভাবে আপডেট হয়েছে!');
        } else {
            await addEmergencyPost(newPayload);
            alert('ইমার্জেন্সি পোস্ট সফলভাবে যুক্ত হয়েছে!');
        }
        closeModal();
      } catch (e) {
        alert('পোস্ট করতে সমস্যা হয়েছে: ' + (e.message || e));
      }
    };
  }, 50);
}
async function registerUser(name,email,password){
  const cred = await firebase.auth().createUserWithEmailAndPassword(email,password);
  await cred.user.updateProfile({ displayName: name });
  await firebase.database().ref('users/' + cred.user.uid).set({ name, email, joined: Date.now(), loginCount: 0 });
  return cred.user;
}
async function loginUser(email,password){
  const u = await firebase.auth().signInWithEmailAndPassword(email,password);
  return u.user;
}
async function logoutUser(){
  await firebase.auth().signOut();
}
async function addDonor(donor){
  const id = donor.id || ('d_' + Date.now() + '_' + Math.floor(Math.random()*9999));
  donor.id = id; donor.owner = currentUser ? currentUser.uid : null; donor.createdAt = donor.createdAt || Date.now();
  await firebase.database().ref('donors/' + id).set(donor);
}
async function updateDonor(id,payload){
  await firebase.database().ref('donors/' + id).update(payload);
}
async function deleteDonor(id){
  if(!confirm('ডোনার মুছে ফেলতে চান?')) return;
  await firebase.database().ref('donors/' + id).remove();
}
function openRatingModal(donorId){
  if(!currentUser){
    openAuthModal('login');
    return;
  }
  const d = donors[donorId];
  if(!d) return;
  const userRatings = Object.values(d.ratings || {}).filter(r => r.rater === currentUser.uid);
  if(userRatings.length > 0){
    openModal(`
      <h3>You've Already Rated</h3>
      <p class="muted">তুমি এই ডোনারকে একবার রেটিং দিয়েছ। একাধিকবার রেটিং দেওয়া যাবে না।</p>
      <div style="margin-top:12px;text-align:center">
        ${renderStars(userRatings[0].rating)}
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn ghost" onclick="closeModal()">Close</button>
      </div>
    `);
    return;
  }
  openModal(`
    <h3>Rate ${escapeHtml(d.name)}</h3>
    <div style="margin-top:12px;text-align:center">
      <div id="ratingStars" class="ratings" style="font-size:36px;cursor:pointer;">
        <span data-rating="1">★</span><span data-rating="2">★</span><span data-rating="3">★</span><span data-rating="4">★</span><span data-rating="5">★</span>
      </div>
    </div>
    <div style="margin-top:16px;">
      <label class="muted small">Your feedback (optional)</label>
      <textarea id="ratingComment" rows="3" style="width:100%;border-radius:8px;padding:8px;border:1px solid var(--glass-border);background:transparent;color:var(--white)"></textarea>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      ${d.phone ? `<a href="tel:${encodeURIComponent(d.phone)}" class="btn ghost" style="text-decoration:none;display:flex;align-items:center;gap:8px">Call Donor</a>` : ''}
      <div style="display:flex;gap:8px;margin-left:auto">
        <button class="btn ghost" onclick="closeModal()">Cancel</button>
        <button class="btn primary" id="submitRatingBtn">Submit Rating</button>
      </div>
    </div>
  `);
  const starsContainer = document.getElementById('ratingStars');
  let selectedRating = 0;
  starsContainer.addEventListener('mouseover', (e) => {
    if(e.target.tagName === 'SPAN'){
      const rating = parseInt(e.target.dataset.rating);
      Array.from(starsContainer.children).forEach(star => {
        const starRating = parseInt(star.dataset.rating);
        star.style.color = starRating <= rating ? '#f5b041' : 'var(--muted)';
      });
    }
  });
  starsContainer.addEventListener('mouseout', () => {
    Array.from(starsContainer.children).forEach(star => {
      const starRating = parseInt(star.dataset.rating);
      star.style.color = starRating <= selectedRating ? '#f5b041' : 'var(--muted)';
    });
  });
  starsContainer.addEventListener('click', (e) => {
    if(e.target.tagName === 'SPAN'){
      selectedRating = parseInt(e.target.dataset.rating);
      Array.from(starsContainer.children).forEach(star => {
        const starRating = parseInt(star.dataset.rating);
        star.style.color = starRating <= selectedRating ? '#f5b041' : 'var(--muted)';
      });
    }
  });
  document.getElementById('submitRatingBtn').addEventListener('click', async () => {
    if(selectedRating === 0){
      alert('রেটিং দিন!');
      return;
    }
    const comment = document.getElementById('ratingComment').value.trim();
    try {
      await firebase.database().ref(`donors/${donorId}/ratings`).push({
        rating: selectedRating,
        comment: comment,
        rater: currentUser.uid,
        timestamp: Date.now()
      });
      alert('রেটিং সফলভাবে জমা হয়েছে!');
      closeModal();
    } catch (error) {
      alert('রেটিং দিতে সমস্যা হয়েছে: ' + error.message);
    }
  });
}
function calculateAverageRating(donor){
  if(!donor.ratings) return { avg: 0, count: 0 };
  const ratings = Object.values(donor.ratings);
  const sum = ratings.reduce((acc, curr) => acc + (curr.rating || 0), 0);
  const avg = ratings.length > 0 ? (sum / ratings.length) : 0;
  return { avg: avg.toFixed(1), count: ratings.length };
}
function openDonorDetailsModal(donorId) {
  const d = donors[donorId];
  if (!d) return;
  const { avg, count } = calculateAverageRating(d);
  const ratingsList = d.ratings ? Object.values(d.ratings) : [];
  const reviewsHtml = ratingsList.map(r => {
    const raterName = users[r.rater] ? users[r.rater].name : 'Anonymous';
    return `
      <div class="review-card">
        <div class="review-header">
          <div>${renderStars(r.rating)}</div>
          <div class="review-meta">${escapeHtml(raterName)}</div>
        </div>
        <div class="muted" style="margin-top:6px">${escapeHtml(r.comment || 'No comment')}</div>
      </div>
    `;
  }).join('');
  openModal(`
    <h3>${escapeHtml(d.name)}</h3>
    <div style="margin-top:10px; display:flex; gap:12px; align-items:center;">
      <div class="avatar" style="width: 80px; height: 80px; font-size: 28px;">${uidInitials(d.name)}</div>
      <div>
        <div class="blood-group">${escapeHtml(d.blood || 'N/A')}</div>
        <div class="meta">${escapeHtml(d.location || '')}</div>
        <div class="muted small">Last Donate : ${d.lastDonateDate ? fmtDate(d.lastDonateDate) : 'N/A'}</div>
      </div>
    </div>
    <div style="margin-top:12px">
      <h4 style="margin:0">Overall Rating: ${avg}/5 (${count} reviews)</h4>
      <div class="ratings" style="margin-top:4px">${renderStars(avg)}</div>
    </div>
    <div style="margin-top:16px">
      <h4 style="margin:0">Reviews</h4>
      <div style="margin-top:8px">${reviewsHtml || '<div class="muted">কোনো রিভিউ নেই।</div>'}</div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn ghost" onclick="closeModal()">Close</button>
      <button class="btn primary" onclick="openRatingModal('${d.id}')">Rate This Donor</button>
    </div>
  `);
}
function renderAll(){
  renderDonorsGrid();
  renderSearchGrid();
  renderMyDonors();
  renderProfile();
  renderEmergencyPosts();
}
function renderDonorsGrid(){
    donorsGrid.innerHTML = '';
    const latestEmergencyPost = Object.values(allEmergencyPosts).sort((a,b)=>b.timestamp - a.timestamp)[0];
    if (latestEmergencyPost) {
        const postEl = document.createElement('div');
        postEl.className = 'emergency-card';
        postEl.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="margin: 0; color: white;">🚨 জরুরি রক্তের প্রয়োজন!</h3>
                <div class="blood-group-large">${latestEmergencyPost.blood}</div>
            </div>
            <p style="margin: 0; font-size: 16px;">
                <span style="font-weight: 600;">রোগী:</span> ${escapeHtml(latestEmergencyPost.patientName)}<br>
                <span style="font-weight: 600;">বিস্তারিত:</span> ${escapeHtml(latestEmergencyPost.details)}
            </p>
            <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center;">
                <a href="tel:${encodeURIComponent(latestEmergencyPost.phone)}" class="btn ghost" style="color: white; border-color: rgba(255,255,255,0.4);">যোগাযোগ করুন</a>
                <div style="font-size: 12px; opacity: 0.7;">পোস্ট করেছেন: ${users[latestEmergencyPost.user] ? users[latestEmergencyPost.user].name : 'Unknown User'}</div>
            </div>
        `;
        donorsGrid.appendChild(postEl);
    }
    const arr = Object.values(donors || {}).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
    if (arr.length === 0 && !latestEmergencyPost) {
        noData.style.display = 'block';
    } else {
        noData.style.display = 'none';
    }
    arr.forEach(d => donorsGrid.appendChild(renderCard(d)));
}
function renderSearchGrid(){
  searchGrid.innerHTML = '';
  const q = (searchInput && searchInput.value || '').trim().toLowerCase();
  const arr = Object.values(donors || {}).sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
  const filtered = arr.filter(d=>{
    if(!q) return true;
    return (d.name||'').toLowerCase().includes(q) || (d.location||'').toLowerCase().includes(q) || (d.blood||'').toLowerCase().includes(q) || (d.phone||'').toLowerCase().includes(q);
  });
  if(filtered.length===0) noSearch.style.display='block'; else noSearch.style.display='none';
  filtered.forEach(d => searchGrid.appendChild(renderCard(d)));
}
function renderMyDonors(){
  myDonorsGrid.innerHTML = '';
  const arr = Object.values(donors || {}).filter(d => d.owner === (currentUser && currentUser.uid)).sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
  if(arr.length===0) noMyDonors.style.display='block'; else noMyDonors.style.display='none';
  arr.forEach(d => myDonorsGrid.appendChild(renderCard(d, false, true)));
}
function renderEmergencyPosts() {
    emergencyGrid.innerHTML = '';
    const posts = Object.entries(allEmergencyPosts).sort(([,a], [,b]) => b.timestamp - a.timestamp);
    if (posts.length === 0) {
        noEmergencyPosts.style.display = 'block';
    } else {
        noEmergencyPosts.style.display = 'none';
        posts.forEach(([postId, post]) => {
            const postEl = document.createElement('div');
            postEl.className = 'emergency-card';
            const isOwner = currentUser && post.user === currentUser.uid;
            postEl.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="margin: 0; color: white;">🚨 জরুরি রক্তের প্রয়োজন!</h3>
                <div class="blood-group-large">${post.blood}</div>
              </div>
              <p style="margin: 0; font-size: 16px;">
                <span style="font-weight: 600;">রোগী:</span> ${escapeHtml(post.patientName)}<br>
                <span style="font-weight: 600;">বিস্তারিত:</span> ${escapeHtml(post.details)}
              </p>
              <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center;">
                <a href="tel:${encodeURIComponent(post.phone)}" class="btn ghost" style="color: white; border-color: rgba(255,255,255,0.4);">যোগাযোগ করুন</a>
                <div style="font-size: 12px; opacity: 0.7;">পোস্ট করেছেন: ${users[post.user] ? users[post.user].name : 'Unknown User'}</div>
              </div>
              ${isOwner ? `
              <div style="display:flex; gap:8px; margin-top:12px">
                <button class="btn primary small" onclick="openEmergencyPostModal('${postId}')">Edit</button>
                <button class="btn ghost small" onclick="deleteEmergencyPost('${postId}')">Delete</button>
              </div>
              ` : ''}
            `;
            emergencyGrid.appendChild(postEl);
        });
    }
}
function renderProfile(){
  const container = document.getElementById('profileInfo');
  if(!currentUser){
    container.innerHTML = `<div class="auth-form-container"><h3>Login / Register</h3><p class="muted" style="text-align: center;">অ্যাক্সেস পেতে লগইন করুন</p><div style="display:flex;gap:8px;margin-top:10px;justify-content:center;"><button class="btn primary" onclick="openAuthModal('register')">Register</button><button class="btn ghost" onclick="openAuthModal('login')">Login</button></div></div>`;
    return;
  }
  const name = currentUser.displayName || currentUser.email || 'User';
  const userEmergencyPosts = Object.entries(allEmergencyPosts).filter(([, post]) => post.user === currentUser.uid);
  const emergencyPostSection = userEmergencyPosts.length > 0 
    ? `<div class="emergency-profile-card">
         <h4 style="margin:0;">🚨 আপনার ইমার্জেন্সি পোস্ট (${userEmergencyPosts.length})</h4>
         <p class="muted small" style="margin-top:4px;">আপনার পোস্ট দেখতে Emergency ট্যাবে যান।</p>
         <div style="margin-top:8px; display:flex; gap:8px;">
           <button class="btn primary small" onclick="setActivePage('emergency')">View Posts</button>
         </div>
       </div>`
    : `<button class="btn emergency" style="width:100%;" onclick="openEmergencyPostModal()">🚨 ইমার্জেন্সি পোস্ট করুন</button>`;
  container.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;border:1px solid var(--glass-border);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)">
      <div style="width:60px;height:60px;border-radius:12px;background:linear-gradient(180deg,#0b1220,#09101a);display:flex;align-items:center;justify-content:center;font-weight:700">${uidInitials(name)}</div>
      <div>
        <h3 style="margin:0">${escapeHtml(name)}</h3>
        <div class="muted small">${escapeHtml(currentUser.email||'')}</div>
      </div>
      <div style="margin-left:auto"><button class="btn ghost" onclick="openEditProfile()">Edit</button></div>
    </div>
    <div style="margin-top:16px">${emergencyPostSection}</div>
  `;
}
function renderCard(d, showCall=false, showEdit=false){
  const el = document.createElement('div');
  el.className = 'card clickable';
  el.onclick = () => openDonorDetailsModal(d.id);
  const lastDate = d.lastDonateDate ? new Date(d.lastDonateDate) : null;
  const nextEligible = lastDate ? new Date(lastDate.getTime() + 1000*60*60*24*120) : null;
  const now = new Date();
  const isEligible = !nextEligible || nextEligible <= now;
  const daysLeft = nextEligible ? daysBetween(now, nextEligible) : null;
  const { avg, count } = calculateAverageRating(d);
  el.innerHTML = `
    <div class="avatar">${uidInitials(d.name)}</div>
    <div class="card-body">
      <div class="name-row">
        <h4 style="margin:0">${escapeHtml(d.name || 'Unknown')}</h4>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="tag ${isEligible ? 'eligible' : 'not-eligible'}">
            ${isEligible ? 'Eligible Now' : 'Not Eligible'}
          </div>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
        <div class="meta">${escapeHtml(d.location || '')}</div>
        <div class="ratings">${renderStars(avg)} <span class="muted small">${avg}/5</span> (${count})</div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;gap:12px">
        <div>
          <div class="blood-group">${escapeHtml(d.blood || 'N/A')}</div>
          <div class="muted small">Last Donate : ${d.lastDonateDate ? fmtDate(d.lastDonateDate) : 'N/A'}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <a href="tel:${encodeURIComponent(d.phone||'')}" title="Call" class="btn ghost" style="display:inline-flex;align-items:center;gap:8px">
            ${d.phone ? 'Call' : 'No Phone'}
          </a>
          ${showEdit && currentUser && d.owner===currentUser.uid 
            ? `<div style="display:flex;gap:8px">
                 <button class="btn ghost small" onclick="event.stopPropagation(); openEditDonor('${d.id}')">Edit</button>
                 <button class="btn ghost small" onclick="event.stopPropagation(); deleteDonor('${d.id}')">Delete</button>
               </div>` 
            : ''}
        </div>
      </div>
    </div>
  `;
  return el;
}
addPage.addEventListener('click', (e) => {
    if (e.target.id === 'addPage' || e.target.closest('#addPlus') === null) {
        if (!currentUser) {
            openAuthModal('login');
            return;
        }
        openAddDonorForm();
    }
});
addPlus.addEventListener('click', () => {
    if (!currentUser) {
        openAuthModal('login');
        return;
    }
    // Remove the class first to allow the animation to re-run on subsequent clicks
    addPlus.classList.remove('spin-animation');

    // A small delay to ensure the class is removed before adding it again
    setTimeout(() => {
        addPlus.classList.add('spin-animation');
    }, 10);

    // When the animation is over, remove the class to reset it
    addPlus.addEventListener('animationend', () => {
        addPlus.classList.remove('spin-animation');
    }, { once: true });

    // Open the add donor form
    openAddDonorForm();
});
function openAuthModal(tab='register'){
  openModal(`
    <div id="authFormContent"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button class="btn ghost" onclick="closeModal()">Close</button></div>
  `);
  showAuthTab(tab);
}
function showAuthTab(tab){
  const c = document.getElementById('authFormContent');
  if(tab==='register'){
    c.innerHTML = `
      <div class="auth-form-container">
        <h3>Register</h3>
        <p class="muted" style="text-align: center;">অ্যাকাউন্ট তৈরি করুন, নিজের ডোনেট করুন অন্যকে উৎসাহিত করুন</p>
        <div class="input-group"><label>Name</label><input id="regName" type="text" placeholder="তোমার নাম" /></div>
        <div class="input-group"><label>Email</label><input id="regEmail" type="email" placeholder="example@mail.com" /></div>
        <div class="input-group"><label>Password</label><input id="regPass" type="password" placeholder="password" /></div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:8px"><input id="tncCheckbox" type="checkbox"/><label class="muted small">I agree to <a href="#" id="openTnC" class="link">terms & conditions</a></label></div>
        <div class="btn-group">
          <button class="btn primary" id="regBtn">Register</button>
        </div>
        <div class="text-link">
          <button class="btn ghost" onclick="showAuthTab('login')">Have A Account? Login Now</button>
        </div>
      </div>`;
    document.getElementById('openTnC').addEventListener('click', (e)=>{ e.preventDefault(); openModal(`<h3>Terms & Conditions</h3><div class="muted">📜 Terms & Conditions (T&C) – Blood App  
<div>1. **Eligibility** - ব্যবহারকারীকে অবশ্যই ন্যূনতম 18 বছর বয়সী হতে হবে।  
   - সঠিক স্বাস্থ্যগত অবস্থায় না থাকলে দান করা যাবে না।  </div>
<div>2. **Accuracy of Information** - ব্যবহারকারী যে তথ্য প্রদান করবে (নাম, বয়স, রক্তের গ্রুপ, যোগাযোগের তথ্য ইত্যাদি) তা অবশ্যই সঠিক হতে হবে।  
   - ভুল তথ্য প্রদান করলে অ্যাকাউন্ট সাসপেন্ড হতে পারে।  </div>
<div>3. **Privacy & Data** - ব্যবহারকারীর ব্যক্তিগত তথ্য নিরাপদ রাখা হবে।  
   - শুধুমাত্র রক্তদাতা ও গ্রহীতার সংযোগের জন্য তথ্য ব্যবহৃত হবে।  </div>
<div>4. **Responsibility** - রক্ত দানের আগে দাতা তার শারীরিক অবস্থা নিশ্চিত করবেন।  
   - রক্ত গ্রহীতা হাসপাতালের নিয়ম মেনে দাতার রক্ত পরীক্ষা করিয়ে নেবেন।  </div>
<div>5. **Prohibited Activities** - ভুয়া প্রোফাইল তৈরি, ভুল তথ্য দেওয়া, অথবা আর্থিক লেনদেন সম্পূর্ণভাবে নিষিদ্ধ।  
   - কোনো ধরনের প্রতারণা বা অপব্যবহার করলে আইনানুগ ব্যবস্থা নেওয়া হবে।  </div>
<div>6. **Liability Disclaimer** - এই অ্যাপ কেবল দাতা ও গ্রহীতার মধ্যে যোগাযোগের মাধ্যম।  
   - রক্ত সংক্রান্ত কোনো ঝুঁকির দায়ভার সম্পূর্ণভাবে দাতা ও গ্রহীতার।  </div>
<div>7. **Modification of Terms** - প্রয়োজন অনুযায়ী শর্তাবলী পরিবর্তন করা হতে পারে।  
   - ব্যবহারকারীরা নিয়মিতভাবে আপডেট চেক করবেন।  </div>
<div>✅ "Agree" বাটনে ক্লিক করার মাধ্যমে আপনি উপরোক্ত সব শর্তাবলী মেনে নিচ্ছেন।</div><div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn ghost" onclick="closeModal()">Close</button></div>`); });
    setTimeout(()=> document.getElementById('regBtn').onclick = async ()=> {
      const name = document.getElementById('regName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const pass = document.getElementById('regPass').value;
      const tnc = document.getElementById('tncCheckbox').checked;
      if(!name || !email || !pass){ alert('সব ফিল্ড পূরণ করুন'); return; }
      if(!tnc){ alert('Terms & Conditions-এ সম্মতি প্রয়োজন'); return; }
      try { await registerUser(name,email,pass); alert('Registration successful'); closeModal(); } catch(e){ alert('Error: ' + (e.message || e)); }
    }, 50);
  } else {
    c.innerHTML = `
      <div class="auth-form-container">
        <h3>Login</h3>
        <p class="muted" style="text-align: center;">আমরা জানতাম আপনি খুব শীগ্রই ফিরে আসবেন ,অ্যাকাউন্টে প্রবেশ করুন</p>
        <div class="input-group"><label>Email</label><input id="loginEmail" type="email" placeholder="example@mail.com" /></div>
        <div class="input-group"><label>Password</label><input id="loginPass" type="password" placeholder="password" /></div>
        <div class="btn-group">
          <button class="btn primary" id="loginBtn">Login</button>
        </div>
        <div class="text-link">
          <button class="btn ghost" onclick="showAuthTab('register')">New User? Registration Now</button>
        </div>
      </div>`;
    setTimeout(()=> document.getElementById('loginBtn').onclick = async ()=> {
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;
      if(!email || !pass){ alert('সব ফিল্ড পূরণ করুন'); return; }
      try{ await loginUser(email,pass); alert('Login successful'); closeModal(); } catch(e){ alert('Error: ' + (e.message || e)); }
    }, 50);
  }
}
function openAppRatingModal() {
  if (!currentUser) return;
  const userRatingsRef = firebase.database().ref(`appRatings/${currentUser.uid}`);
  const userRef = firebase.database().ref(`users/${currentUser.uid}`);
  appRatingsRef.child(currentUser.uid).once('value').then(snapshot => {
    if (snapshot.exists()) {
      return;
    }
    const html = `
      <div class="auth-form-container" style="text-align: center;">
        <h3>অ্যাপটি কেমন লাগছে?</h3>
        <p class="muted">অনুগ্রহ করে একটি রেটিং ও আপনার মতামত দিন। এটি আমাদের অ্যাপকে আরও উন্নত করতে সাহায্য করবে।</p>
        
        <div id="starRatingContainer" style="font-size: 36px; margin: 20px 0; cursor: pointer; display: flex; justify-content: space-around;">
          <span data-rating="1" title="Very Bad">★</span>
          <span data-rating="2" title="Bad">★</span>
          <span data-rating="3" title="Okay">★</span>
          <span data-rating="4" title="Good">★</span>
          <span data-rating="5" title="Very Good">★</span>
        </div>
        <div class="input-group" style="margin-top: 10px;">
          <textarea id="ratingComment" rows="3" placeholder="এখানে আপনার মূল্যবান মন্তব্য লিখুন (ঐচ্ছিক)" style="width:100%;border-radius:8px;padding:8px;border:1px solid var(--glass-border);background:transparent;color:var(--white);"></textarea>
        </div>

        <div class="btn-group" style="justify-content:center;">
          <button class="btn primary" id="submitAppRatingBtn" disabled>রেটিং দিন</button>
        </div>
        <div class="text-link" style="margin-top: 10px;">
          <button class="btn ghost small" onclick="dismissRatingModal()">এখন নয়</button>
        </div>
      </div>
    `;
    openModal(html);
    
    const starContainer = document.getElementById('starRatingContainer');
    const submitBtn = document.getElementById('submitAppRatingBtn');
    const ratingComment = document.getElementById('ratingComment');
    let selectedRating = 0;

    starContainer.addEventListener('click', (e) => {
      if (e.target.tagName === 'SPAN') {
        selectedRating = parseInt(e.target.dataset.rating);
        document.querySelectorAll('#starRatingContainer span').forEach(span => {
          const starRating = parseInt(span.dataset.rating);
          span.style.color = starRating <= selectedRating ? '#f5b041' : 'var(--muted)';
        });
        submitBtn.disabled = false;
      }
    });

    submitBtn.onclick = () => {
      if (selectedRating === 0) {
        alert("রেটিং দিন!");
        return;
      }
      appRatingsRef.child(currentUser.uid).set({ 
        rating: selectedRating, 
        comment: ratingComment.value.trim(),
        timestamp: Date.now() 
      })
      .then(() => {
        userRef.update({ appRated: true });
        alert('আপনার রেটিং এবং মূল্যবান মতামতের জন্য ধন্যবাদ!');
        closeModal();
      })
      .catch(error => {
        alert('রেটিং সংরক্ষণ করতে সমস্যা হয়েছে।');
        console.error("Error saving app rating:", error);
        closeModal();
      });
    };
  });
}
window.dismissRatingModal = () => {
  const userRef = firebase.database().ref(`users/${currentUser.uid}`);
  const nextShowTime = Date.now() + 7 * 24 * 60 * 60 * 1000; // ৭ দিন পর
  userRef.update({ showRatingAfter: nextShowTime });
  closeModal();
};

function openCalendarModal(initialDate) {
    customCalendarModal.classList.add('visible');
    currentCalendarDate = initialDate ? new Date(initialDate) : new Date();
    renderCalendar();
}

function closeCalendarModal() {
    customCalendarModal.classList.remove('visible');
}

function renderCalendar() {
    calendarGrid.innerHTML = '';
    const today = new Date();
    const month = currentCalendarDate.getMonth();
    const year = currentCalendarDate.getFullYear();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    calendarMonthYear.textContent = new Date(year, month).toLocaleString('en-US', { month: 'long', year: 'numeric' });
    calendarMonthYear.prepend("Blood Calendar - ");

    const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    daysOfWeek.forEach(day => {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = day;
        calendarGrid.appendChild(dayEl);
    });

    for (let i = 0; i < firstDay; i++) {
        calendarGrid.appendChild(document.createElement('div'));
    }

    for (let i = 1; i <= daysInMonth; i++) {
        const dateEl = document.createElement('div');
        dateEl.className = 'calendar-date';
        dateEl.textContent = i;
        const date = new Date(year, month, i);

        if (date.toDateString() === today.toDateString()) {
            dateEl.classList.add('current');
        }

        if (activeDateInput && activeDateInput.value) {
            const selectedDate = new Date(activeDateInput.value);
            if (date.toDateString() === selectedDate.toDateString()) {
                dateEl.classList.add('selected');
            }
        }
        
        dateEl.addEventListener('click', () => {
            if (activeDateInput) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                activeDateInput.value = `${y}-${m}-${d}`;
                closeCalendarModal();
            }
        });

        calendarGrid.appendChild(dateEl);
    }
}
prevMonthBtn.addEventListener('click', () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    renderCalendar();
});
nextMonthBtn.addEventListener('click', () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    renderCalendar();
});
clearDateBtn.addEventListener('click', () => {
    if(activeDateInput) {
        activeDateInput.value = '';
        closeCalendarModal();
    }
});

function openAddDonorForm(prefill){
  const d = prefill || {name:'',phone:'',blood:'A+',location:'',lastDonateDate:'',willing:false};
  openModal(`
    <div class="auth-form-container">
      <h3>${prefill ? 'Edit Donor' : 'Add Donor'}</h3>
      <p>রক্তদান একটি মহৎ কাজ, আপনার তথ্য দিয়ে অন্যদের সাহায্য করুন।</p>
      
      <div class="input-group">
        <label for="donName">Name</label>
        <input id="donName" type="text" value="${escapeHtml(d.name||'')}" placeholder="তোমার নাম"/>
      </div>
      
      <div class="input-group">
        <label for="donPhone">Phone</label>
        <input id="donPhone" type="tel" value="${escapeHtml(d.phone||'')}" placeholder="ফোন নম্বর"/>
      </div>
      
      <div class="input-group">
        <label for="donBlood">Blood Group</label>
        <select id="donBlood">
          <option value="A+" ${d.blood==='A+'?'selected':''}>A+</option>
          <option value="A-" ${d.blood==='A-'?'selected':''}>A-</option>
          <option value="B+" ${d.blood==='B+'?'selected':''}>B+</option>
          <option value="B-" ${d.blood==='B-'?'selected':''}>B-</option>
          <option value="O+" ${d.blood==='O+'?'selected':''}>O+</option>
          <option value="O-" ${d.blood==='O-'?'selected':''}>O-</option>
          <option value="AB+" ${d.blood==='AB+'?'selected':''}>AB+</option>
          <option value="AB-" ${d.blood==='AB-'?'selected':''}>AB-</option>
        </select>
      </div>
      
      <div class="input-group">
        <label for="donLocation">Location</label>
        <input id="donLocation" type="text" value="${escapeHtml(d.location||'')}" placeholder="আপনার ঠিকানা"/>
      </div>
      
      <div class="input-group">
          <label for="donLast">Last Donate Date</label>
          <input type="text" id="donLastDisplay" placeholder="তারিখ সিলেক্ট করুন" readonly style="cursor: pointer;"/>
          <input type="hidden" id="donLastInput" value="${d.lastDonateDate ? formatInputDate(d.lastDonateDate) : ''}" />
      </div>

      <div class="input-group" style="display:flex;align-items:center;gap:8px;">
        <input id="donWilling" type="checkbox" ${d.willing ? 'checked' : ''} style="width:auto;"/>
        <label for="donWilling" class="muted small">Willing to donate</label>
      </div>
      
      <div class="btn-group">
        <button class="btn ghost" onclick="closeModal()">Cancel</button>
        <button class="btn primary" id="saveDonorBtn">${prefill ? 'Update' : 'Add'}</button>
      </div>
    </div>
  `);
  
  const donLastDisplay = document.getElementById('donLastDisplay');
  const donLastInput = document.getElementById('donLastInput');
  donLastDisplay.value = donLastInput.value;
  
  donLastDisplay.addEventListener('click', () => {
      activeDateInput = donLastInput;
      const initialDate = donLastInput.value ? new Date(donLastInput.value) : new Date();
      openCalendarModal(initialDate);
  });

  setTimeout(()=> {
    document.getElementById('saveDonorBtn').onclick = async ()=> {
      const payload = {
        name: document.getElementById('donName').value.trim(),
        phone: document.getElementById('donPhone').value.trim(),
        blood: document.getElementById('donBlood').value,
        location: document.getElementById('donLocation').value.trim(),
        lastDonateDate: donLastInput.value ? new Date(donLastInput.value).toISOString() : null,
        willing: document.getElementById('donWilling').checked
      };
      if(!payload.name || !payload.phone){ 
        alert('Name ও Phone বাধ্যতামূলক'); 
        return; 
      }
      try{
        if(prefill && prefill.id){
          await updateDonor(prefill.id, payload);
          alert('ডোনারের তথ্য সফলভাবে আপডেট হয়েছে!');
        } else {
          await addDonor(payload);
          closeModal();
          openModal(`
            <h3>শুভেচ্ছা!</h3>
            <p class="muted" style="text-align: center;font-size:16px;">একজন নতুন রক্তযোদ্ধাকে পেয়ে আমরা আনন্দিত। আপনার এই মহৎ উদ্যোগের জন্য আপনাকে ধন্যবাদ!</p>
            <div style="display:flex;justify-content:flex-end;margin-top:12px;">
              <button class="btn primary" onclick="closeModal()">Done</button>
            </div>
          `);
        }
      } catch(e){ 
        alert('তথ্য সংরক্ষণে সমস্যা হয়েছে: ' + (e.message || e)); 
      }
    };
  }, 50);
}
function openEditDonor(id){
  const d = donors[id];
  if(!d){ alert('ডেটা মেলেনি'); return; }
  if(!currentUser || d.owner !== currentUser.uid){ alert('তুমি এই কার্ড এডিট করতে পারবে না'); return; }
  openAddDonorForm(d);
}
function openEditProfile(){
  if(!currentUser) return openAuthModal('login');
  openModal(`<h3>Edit Profile</h3><div style="margin-top:8px"><div class="auth-compact"><label class="muted small">Name</label><input id="editName" value="${escapeHtml(currentUser.displayName||'')}" /><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn ghost" onclick="closeModal()">Cancel</button><button class="btn primary" id="saveProfileBtn">Save</button></div></div></div>`);
  setTimeout(()=> {
    document.getElementById('saveProfileBtn').onclick = async ()=> {
      const name = document.getElementById('editName').value.trim();
      if(!name){ alert('Name লিখুন'); return; }
      await firebase.auth().currentUser.updateProfile({ displayName: name });
      await firebase.database().ref('users/' + firebase.auth().currentUser.uid).update({ name });
      closeModal();
      alert('Profile updated');
    };
  }, 50);
}
aboutBtn.addEventListener('click', ()=> { 
  closeMenuFunc(); 
  openModal(`
    <h3>About Blood</h3>
    <div class="muted">
      Blood অ্যাপটি তৈরি করা হয়েছে রক্তদাতা ও রক্ত প্রয়োজনদের মধ্যে একটি সহজ ও দ্রুত সংযোগ স্থাপনের জন্য। 
      এখানে আপনি রক্তদাতাদের তালিকা দেখতে, রেটিং দিতে, কমেন্ট করতে এবং নতুন ডোনার রেজিস্টার করতে পারবেন। 
      এটি বিশেষভাবে মোবাইল ফ্রেন্ডলি এবং ইউজার-ফ্রেন্ডলি ডিজাইন করা হয়েছে। 
      উদ্দেশ্য হলো সময়মতো রক্তের প্রয়োজনীয়তা মেটানো এবং রক্তদাতাদের সাথে সহজ যোগাযোগ নিশ্চিত করা।
      <h2> <a> Blood Team </a> কোনো প্রকার আর্থিক লেনদেন সাপোর্ট করে না, সুতরাং অর্থ লেনদেন এড়িয়ে চলুন </h2>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button class="btn ghost" onclick="closeModal()">Close</button>
    </div>
  `); 
});
guidelinesBtn.addEventListener('click', ()=> { 
  closeMenuFunc(); 
  openModal(`
    <h3>Guidelines</h3>
    <div class="muted">
      ১. ডোনারের সাথে সব সময় বিনীত ও সম্মানজনকভাবে কথা বলুন।<br>
      ২. নির্ধারিত সময়ে পৌঁছান এবং সময়মতো দান সম্পন্ন করুন।<br>
      ৩. নিজের স্বাস্থ্য বিবেচনা করুন; যদি অসুস্থ বোধ করেন, রক্ত দান করবেন না।<br>
      ৪. রক্তদাতার তথ্য গোপন রাখুন এবং শুধুমাত্র প্রয়োজনীয় ব্যবহার করুন।<br>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button class="btn ghost" onclick="closeModal()">Close</button>
    </div>
  `); 
});
logoutBtn.addEventListener('click', ()=> {
  closeMenuFunc();
  logoutReasonModal.style.display = 'flex';
});
if(searchInput){
  searchInput.addEventListener('input', ()=> {
    renderSearchGrid();
    if(searchInput.value.length > 0) {
        clearSearch.classList.add('visible');
    } else {
        clearSearch.classList.remove('visible');
    }
  });
  clearSearch.addEventListener('click', ()=> { 
    searchInput.value=''; 
    renderSearchGrid(); 
    clearSearch.classList.remove('visible');
  });
}
setInterval(()=> { renderDonorsGrid(); renderSearchGrid(); renderMyDonors(); renderEmergencyPosts(); }, 60*1000);
window.openAuthModal = openAuthModal;
window.openEditDonor = openEditDonor;
window.openEditProfile = openEditProfile;
window.deleteDonor = deleteDonor;
window.openRatingModal = openRatingModal;
window.openDonorDetailsModal = openDonorDetailsModal;
window.openEmergencyPostModal = openEmergencyPostModal;
window.deleteEmergencyPost = deleteEmergencyPost;
window.setActivePage = setActivePage;
function scrollToTop() {
    document.querySelector('main').scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}
window.scrollToTop = scrollToTop;
renderAll();
const logoutReasonModalElement = document.getElementById("logoutReasonModal");
const logoutReasonInputElement = document.getElementById("logoutReasonInput");
const logoutReasonSubmitButton = document.getElementById("logoutReasonSubmit");
if(logoutReasonSubmitButton) {
  logoutReasonSubmitButton.addEventListener("click", () => {
    let reason = logoutReasonInputElement.value.trim();
    if (reason === "") {
      alert("কারণ লিখতে হবে!");
      return;
    }
    firebase.auth().signOut().then(() => {
      alert("আপনি লগআউট হয়েছেন!");
      logoutReasonModalElement.style.display = "none";
    }).catch((error) => {
      console.error("Logout Error:", error);
    });
  });
}
</script>
</body>
</html>
